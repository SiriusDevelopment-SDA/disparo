<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campanhas</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: #1e1f23;
        color: #ffffff;
        line-height: 1.6;
      }

      .container {
        /* max-width: 1400px; */
        margin: 0 auto;
        padding: 20px;
        background-color: #1e1f23;
        min-height: 100vh;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #333;
      }

      .header h1 {
        font-size: 32px;
        font-weight: 700;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header h1::before {
        content: "üì°";
        font-size: 28px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #ffcd03 0%, #ffb800 100%);
        color: #1e1f23;
        border: none;
        padding: 14px 28px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(255, 205, 3, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 205, 3, 0.4);
      }

      .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 30px;
        border-bottom: 2px solid #333;
        background-color: #2a2b30;
        border-radius: 10px 10px 0 0;
      }

      .tab-button {
        background: none;
        border: none;
        padding: 16px 24px;
        font-size: 14px;
        font-weight: 500;
        color: #888;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        position: relative;
      }

      .tab-button.active {
        color: #ffcd03;
        border-bottom-color: #ffcd03;
        background-color: #1e1f23;
      }

      .tab-button:hover {
        color: #ffcd03;
        background-color: #333;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .nova-campanha {
        background: linear-gradient(135deg, #2a2b30 0%, #333 100%);
        padding: 30px;
        border-radius: 16px;
        margin-bottom: 30px;
        border: 1px solid #444;
      }

      .nova-campanha h2 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 24px;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .nova-campanha h2::before {
        content: "üöÄ";
        font-size: 20px;
      }

      .form-section {
        background: #1e1f23;
        padding: 50px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        border: 1px solid #444;
        
      }
      .select-location-search {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
        justify-content: space-between;
        text-align: center;
      }
      .form-section h3 {
        font-size: 18px;
        font-weight: 600;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
        margin-top: 50px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 14px;
        font-weight: 600;
        color: #ccc;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .form-group input,
      .form-group select {
        padding: 14px 16px;
        border: 2px solid #444;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background-color: #2a2b30;
        color: #ffffff;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #ffcd03;
        box-shadow: 0 0 0 3px rgba(255, 205, 3, 0.1);
      }

      .vencidos-section {
        background: linear-gradient(135deg, #3a3b40 0%, #2a2b30 100%);
        border: 2px solid #ffcd03;
        border-radius: 12px;
        padding: 20px;
      }

      .vencidos-section h3::before {
        content: "‚ö†Ô∏è";
      }

      .clientes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .cliente-card {
        background: #1e1f23;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #ffcd03;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .cliente-card h4 {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 8px;
      }

      .cliente-info {
        font-size: 14px;
        color: #ccc;
        margin-bottom: 4px;
      }

      .dias-vencido {
        background: #dc2626;
        color: #ffffff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        margin-top: 8px;
      }

      .file-upload {
        margin-bottom: 20px;
        margin-top: 50px;
      }

      .file-upload input[type="file"] {
        display: none;
      }

      .file-upload-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 20px;
        background: linear-gradient(135deg, #2a2b30 0%, #333 100%);
        border: 2px dashed #ffcd03;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #ffcd03;
        font-weight: 500;
      }

      .file-upload-label:hover {
        border-color: #ffb800;
        background: linear-gradient(135deg, #333 0%, #3a3b40 100%);
      }

      .message-preview {
        background: #2a2b30;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #444;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .whatsapp-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
      }

      .message-text {
        flex: 1;
        color: #ffffff;
        font-size: 15px;
        line-height: 1.5;
      }

      .actions {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #2a2b30 0%, #333 100%);
        color: #ffffff;
        border: 2px solid #444;
        padding: 14px 24px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, #333 0%, #3a3b40 100%);
        border-color: #ffcd03;
        transform: translateY(-1px);
      }

      .campanhas-section h2 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 24px;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .campanhas-section h2::before {
        content: "üìä";
        font-size: 20px;
      }

      .table-container {
        background: #2a2b30;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        border: 1px solid #444;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: linear-gradient(135deg, #ffcd03 0%, #ffb800 100%);
        color: #1e1f23;
        padding: 18px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
      }

      td {
        padding: 16px;
        border-bottom: 1px solid #444;
        font-size: 14px;
        color: #ffffff;
      }

      tr:hover {
        background-color: #333;
      }

      .status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status.ativa {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
      }

      .status.agendada {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
      }

      .status.pausada {
        background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        color: #991b1b;
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        margin-right: 8px;
        transition: all 0.2s ease;
        font-weight: 500;
      }

      .btn-pause {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
      }

      .btn-pause:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      }

      .btn-report {
        background: linear-gradient(135deg, #19a775 0%, #19a775 100%);
        color: white;
      }

      .btn-edit {
        background: linear-gradient(135deg, #2b6bee 0%, #2b6bee 100%);
        color: white;
      }

      .btn-report:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background: #1e1f23;
        margin: 3% auto;
        padding: 40px;
        border-radius: 16px;
        width: 90%;
        max-width: 700px;
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid #444;
      }

      .close {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 28px;
        cursor: pointer;
        color: #ccc;
        transition: color 0.2s ease;
      }

      .close:hover {
        color: #ffcd03;
      }

      .notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 24px;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  z-index: 1001;
  opacity: 0;
  transition: opacity 0.6s ease; /* fade suave */
}

.notification.show {
  opacity: 1;
}


      .notification.success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .notification.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #ffcd03 0%, #ffb800 100%);
        color: #1e1f23;
        padding: 24px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(255, 205, 3, 0.3);
      }

      .stat-card h3 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .stat-card p {
        font-size: 14px;
        opacity: 0.9;
      }

      .toggle {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
      }
      .toggle input {
        opacity: 0;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        cursor: pointer;
        margin: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #222;
        transition: 0.4s;
        border-radius: 30px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 24px;
        width: 24px;
        left: 3px;
        bottom: 3px;
        background-color: #ffcc00;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #ffcc00;
      }
      input:checked + .slider:before {
        transform: translateX(30px);
        background-color: #222;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .header {
          flex-direction: column;
          gap: 16px;
          align-items: stretch;
        }

        .tabs {
          flex-direction: column;
        }

        .actions {
          flex-direction: column;
        }

        .table-container {
          overflow-x: auto;
        }
        
        .form-group.button-group {
  display: flex;
  align-items: flex-end;
}

.btn-primary {
  background-color: #4CAF50; /* ou a cor da sua paleta */
  border: none;
  padding: 10px 20px;
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}

.btn-primary:hover {
  background-color: #45a049;
}


        .clientes-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Campanhas</h1>
        <button class="btn-primary" onclick="showNovaCampanha()">
          <span>+</span> Nova Campanha
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalClientes" >0</h3>
          <p>Total de Clientes</p>
        </div>
        <div class="stat-card">
          <h3 id="clientesVencidos">0</h3>
          <p>Clientes Vencidos</p>
        </div>
        <div class="stat-card">
          <h3 id="campanhasAtivas">###</h3>
          <p>Campanhas Ativas</p>
        </div>
        <div class="stat-card">
          <h3 id="mensagensEnviadas">0</h3>
          <p>Mensagens Enviadas</p>
        </div>
      </div>

      <div class="tabs">
        <button
          class="tab-button active"
          onclick="showTab('contatos')"
          id="contactsERP"
        >
          Clientes ERP
        </button>
        <button class="tab-button" onclick="showTab('vencidos')">
          Clientes Vencidos
        </button>
        <button class="tab-button" onclick="showTab('templates')">
          Templates
        </button>
        <button class="tab-button" onclick="showTab('historico')">
          Hist√≥rico
        </button>
      </div>

      <div id="contatos" class="tab-content active">
        <div class="nova-campanha">
          <h2>Nova Campanha</h2>

          <div class="form-section">
            <div class="select-location-search">
              <h3>üîç Buscar Cliente</h3>
              <!-- <label class="toggle">
                <input id="toggle" type="checkbox" />
                <span class="slider"></span>
              </label> -->

              </div>

            <div class="form-row">
              <div class="form-group">
                <label id="searchLabelLocation">Buscar cliente no ERP</label>
                <input
                  type="text"
                  id="buscarContato"
                  placeholder="nome, cpf ou cnpj"
                  oninput="buscarContato(this.value)"
                />
              </div>
              <div class="form-group">
  <label>N√∫mero WhatsApp</label>
  <input type="text" id="numero" placeholder="(11) 99999-9999" maxlength="15" />
</div>

<script>
  const input = document.getElementById("numero");

  input.addEventListener("input", function (e) {
    let valor = e.target.value.replace(/\D/g, ""); // mant√©m s√≥ n√∫meros

    // se n√£o tiver nada, limpa
    if (!valor) {
      e.target.value = "";
      return;
    }

    // limita a 11 d√≠gitos
    valor = valor.substring(0, 11);

    // aplica a m√°scara
    if (valor.length > 6) {
      // celular com 9 d√≠gitos
      e.target.value = valor.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, "($1) $2-$3");
    } else if (valor.length > 2) {
      // DDD + at√© 5 d√≠gitos
      e.target.value = valor.replace(/^(\d{2})(\d{0,5})/, "($1) $2");
    } else {
      // s√≥ DDD
      e.target.value = valor.replace(/^(\d*)/, "($1");
    }
  });

  // truque: deixa deletar o "-" sem ele reaparecer √† for√ßa
  input.addEventListener("keydown", function (e) {
    if (e.key === "Backspace") {
      const cursor = input.selectionStart;
      if (input.value[cursor - 1] === "-") {
        // pula o "-" e apaga o n√∫mero anterior
        input.setSelectionRange(cursor - 1, cursor - 1);
      }
    }
  });
</script>

              <div class="form-group">
                <label id="searchLabelLocation">Nome da campanha</label>
                <input
                  type="text"
                  id="buscarContato"
                  placeholder="Cobran√ßas 01/2024"
                  oninput="buscarContato(this.value)"
                />
              </div>

             <div class="form-group">
  <label>Template da Mensagem</label>
  <select id="templateDropdown" onchange="updateDropdownPreview()">
    <option value="">Selecionar template</option>
  </select>
</div>

<script>
// let dropdownTemplatesCache = []; // cache exclusivo do dropdown

async function carregarTemplatesDropdown() {
  try {
    // Endpoint espec√≠fico para trazer templates
    const res = await fetch("https://webhooks.coraxy.com.br/webhook/templates1");
    const templates = await res.json();

    dropdownTemplatesCache = templates; // guarda s√≥ para o dropdown

    const select = document.getElementById("templateDropdown");
    select.innerHTML = '<option value="">Selecionar template</option>';

    templates.forEach(tpl => {
      const option = document.createElement("option");
      option.value = tpl.id; 
      option.textContent = tpl.nome_template;
      select.appendChild(option);
    });

  } catch (err) {
    console.error("Erro ao carregar templates no dropdown:", err);
  }
}

function updateDropdownPreview() {
  const select = document.getElementById("templateDropdown");
  const preview = document.getElementById("messagePreview"); // üëà agora atualiza o card de baixo

  const selectedId = select.value;
  if (!selectedId) {
    preview.textContent = "Selecione um template para visualizar a mensagem";
    return;
  }

  const tpl = dropdownTemplatesCache.find(t => String(t.id) === selectedId);
  if (tpl) {
    preview.textContent = tpl.conteudo || "Este template n√£o possui conte√∫do.";
  } else {
    preview.textContent = "Erro: template n√£o encontrado.";
  }
}


</script>



            </div>
          </div>

          <div class="form-section">
            <h3>üìÅ Importar Contatos </h3>
            
            <div class="file-upload">
              <label for="fileUpload" class="file-upload-label">
                üìÑ Carregar arquivo TXT/CSV com n√∫meros
                <span style="font-size: 12px; opacity: 0.8"
                  >(um n√∫mero por linha)</span
                >
              </label>
              <input
                type="file"
                id="fileUpload"
                accept=".txt,.csv"
                onchange="processFile(this)"
              />
            </div>
            <table
              id="tabelaNumeros"
              style="
                display: none;
                margin-top: 15px;
                width: 100%;
                border-collapse: collapse;
              "
            >
              <thead>
                <tr>
                  <th
                    style="
                      padding: 8px;
                      border-bottom: 1px solid #292929;
                      color: #444;
                      font-weight: 600;
                      border-top-right-radius: 4px;
                      border-top-left-radius: 4px;
                      text-align: center;
                    "
                  >
                    N√∫meros Importados
                  </th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="message-preview">
            <div class="whatsapp-icon">W</div>
            <div class="message-text" id="messagePreview">
              Selecione um template para visualizar a mensagem
            </div>
          </div>

          <div class="actions">
            <button class="btn-primary" onclick="enviarCampanha()">
              üöÄ Enviar Agora
            </button>
            <button class="btn-secondary" onclick="agendarCampanha()">
              ‚è∞ Agendar Disparo
            </button>
           
          </div>
        </div>

        <div class="campanhas-section">
  <h2>Campanhas Ativas</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Campanha</th>
          <th>Tipo</th>
          <th>Empresa</th>
          <th>Status</th>
          <th>Enviados</th>
          <th>Taxa Entrega</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="campanhasTable">
        <!-- As campanhas ser√£o carregadas dinamicamente via API -->
      </tbody>
    </table>
  </div>
</div>

      </div>

      <div id="vencidos" class="tab-content">
        <div class="vencidos-section">
          <h3>Buscar Clientes Vencidos</h3>
          <button class="btn-small btn-criarCampanha" onclick="criarCampanha('${camp.id}')">Criar Campanha</button>
          
          <div class="form-row">
            
            <div class="form-group">
              <label>Vencidos h√° quantos dias?</label>
              <select id="diasVencidos" onchange="buscarClientesVencidos()">
                <option value="">Selecione o per√≠odo</option>
                <option value="30">30 dias</option>
                <option value="60">60 dias</option>
                <option value="90">90 dias</option>
                <option value="120">120 dias</option>
                <option value="180">180 dias</option>
                <option value="365">1 ano ou mais</option>
              </select>
            </div>
            <div class="form-group">
              <label>Valor m√≠nimo da d√≠vida</label>
              <input
                type="number"
                id="valorMinimo"
                placeholder="R$ 0,00"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label>Plano do cliente</label>
              <select id="planoCliente">
                <option value="">Todos os planos</option>
                <option value="basico">B√°sico (10MB)</option>
                <option value="intermediario">Intermedi√°rio (50MB)</option>
                <option value="avancado">Avan√ßado (100MB)</option>
                <option value="premium">Premium (200MB)</option>
                <option value="empresarial">Empresarial</option>
              </select>
            </div>
          </div>

          <div class="clientes-grid" id="clientesVencidosGrid">
            <!-- Clientes vencidos ser√£o carregados aqui -->
          </div>

          
        </div>
      </div>


<div id="templates" class="tab-content">
  
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Nome do Template</th>
          <th>Categoria</th>
          <th>Uso</th>
          <th>Taxa de Resposta</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="templatesTable">
        <!-- Os templates ser√£o carregados dinamicamente -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Edi√ß√£o Template -->
<div id="editarTemplateModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h2>Editar Template</h2>
    <input type="hidden" id="editTemplateId">
    <div class="form-group">
      <label>Nome</label>
      <input type="text" id="editTemplateNome">
    </div>
    <div class="form-group">
      <label>Categoria</label>
      <input type="text" id="editTemplateCategoria">
    </div>
    <div class="form-group">
      <label>Conte√∫do</label>
      <textarea id="editTemplateConteudo" rows="6"></textarea>
    </div>
    <button class="btn-primary" onclick="salvarTemplate()">Salvar Altera√ß√µes</button>
  </div>
</div>

      <div id="historico" class="tab-content">
        <h2>Hist√≥rico de Disparos</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Data/Hora</th>
                <th>Cliente</th>
                <th>N√∫mero</th>
                <th>Template</th>
                <th>Status</th>
                <th>Resposta</th>
                <th>Valor Cobrado</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>15/12/2024 14:30</td>
                <td>Jo√£o Silva</td>
                <td>+55 11 99999-9999</td>
                <td>Cobran√ßa Amig√°vel</td>
                <td><span class="status ativa">Entregue</span></td>
                <td>Sim</td>
                <td>R$ 89,90</td>
              </tr>
              <tr>
                <td>15/12/2024 14:29</td>
                <td>Maria Santos</td>
                <td>+55 11 88888-8888</td>
                <td>Promo√ß√£o Fibra</td>
                <td><span class="status ativa">Entregue</span></td>
                <td>N√£o</td>
                <td>-</td>
              </tr>
              <tr>
                <td>15/12/2024 14:25</td>
                <td>Pedro Costa</td>
                <td>+55 11 77777-7777</td>
                <td>Cobran√ßa Urgente</td>
                <td><span class="status ativa">Entregue</span></td>
                <td>Sim</td>
                <td>R$ 156,80</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal para Relat√≥rios -->
    <div id="relatorioModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="relatorioTitle">Relat√≥rio da Campanha</h2>
        <div id="relatorioContent">
          <div class="stats-grid">
            <div class="stat-card">
              <h3 id="totalContatos">0</h3>
              <p>Total de Contatos</p>
            </div>
            <div class="stat-card">
              <h3 id="mensagensEnviadas">0</h3>
              <p>Mensagens Enviadas</p>
            </div>
            <div class="stat-card">
              <h3 id="mensagensEntregues">0</h3>
              <p>Mensagens Entregues</p>
            </div>
            <div class="stat-card">
              <h3 id="respostasRecebidas">0</h3>
              <p>Respostas Recebidas</p>
            </div>
          </div>
          <p>
            <strong>Taxa de Entrega:</strong> <span id="taxaEntrega">0%</span>
          </p>
          <p>
            <strong>Taxa de Resposta:</strong> <span id="taxaResposta">0%</span>
          </p>
          <p>
            <strong>Valor Total Cobrado:</strong>
            <span id="valorTotalCobrado">R$ 0,00</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification"></div>

    <script>


        // Inicializa√ß√£o
document.addEventListener("DOMContentLoaded", () => {
  updateDropdownPreview();
  atualizarTabelaCampanhas();
  carregarRascunho();
  carregarTotalClientes();
  carregarTotalVencidos();
  campanhas_ativas();
  cobrancas_feitas();
  carregarTemplates();
  carregarTemplatesDropdown();
  carregarCampanhas();
});




      let usarMaestroParaBusca = false;
      // Dados simulados para provedor de internet
      let clientes = [
         { nome: 'Jo√£o Silva', numero: '+55 11 99999-9999', doc: '123.456.789-00', plano: 'Fibra 100MB', valor: 89.90, diasVencido: 15 },
         { nome: 'Jo√£o Matheus', numero: '+55 11 99999-5555', doc: '123.456.789-00', plano: 'Fibra 100MB', valor: 89.90, diasVencido: 15 },
         { nome: 'Maria Santos', numero: '+55 11 88888-8888', doc: '987.654.321-00', plano: 'Fibra 50MB', valor: 69.90, diasVencido: 0 },
         { nome: 'Pedro Costa', numero: '+55 11 77777-7777', doc: '456.789.123-00', plano: 'Fibra 200MB', valor: 129.90, diasVencido: 45 },
         { nome: 'Ana Oliveira', numero: '+55 11 66666-6666', doc: '789.123.456-00', plano: 'Fibra 100MB', valor: 89.90, diasVencido: 120 },
         { nome: 'Carlos Ferreira', numero: '+55 11 55555-5555', doc: '321.654.987-00', plano: 'B√°sico 10MB', valor: 39.90, diasVencido: 90 },
         { nome: 'Lucia Mendes', numero: '+55 11 44444-4444', doc: '654.987.321-00', plano: 'Fibra 50MB', valor: 69.90, diasVencido: 30 }
      ];

      let total_clientes = 0; 
      let clientes_vencidos = 0;
      let campanhas1 = 0;
      let cobrancas_enviadas = 0;
      let templates1 = 0;
      

      let campanhas = [
        {
          nome: "Cobran√ßa Dezembro",
          tipo: "Cobran√ßa",
          contatos: 450,
          status: "ativa",
          enviados: 425,
          entregues: 401,
          respostas: 65,
          valorTotal: 28450.5,
        },
        {
          nome: "Promo√ß√£o Fibra",
          tipo: "Marketing",
          contatos: 1200,
          status: "ativa",
          enviados: 1150,
          entregues: 1102,
          respostas: 247,
          valorTotal: 0,
        },
        {
          nome: "Manuten√ß√£o Programada",
          tipo: "Informativo",
          contatos: 800,
          status: "agendada",
          enviados: 0,
          entregues: 0,
          respostas: 0,
          valorTotal: 0,
        },
      ];

      let templates = {
        cobranca_amigavel:
          "Ol√° {{nome}}! Seu plano {{plano}} vence hoje. Para manter sua internet ativa, efetue o pagamento de R$ {{valor}}. Pix: provedor@email.com",
        cobranca_urgente:
          "‚ö†Ô∏è {{nome}}, sua internet ser√° suspensa em 24h! D√©bito de R$ {{valor}} do plano {{plano}}. Pague agora: Pix provedor@email.com",
        promocao_fidelidade:
          "üéâ {{nome}}, oferta especial! Upgrade para Fibra 200MB por apenas R$ 99,90. V√°lido at√© 31/12. Responda SIM para ativar!",
        manutencao_rede:
          "üîß {{nome}}, manuten√ß√£o programada na sua regi√£o dia 20/12 das 2h √†s 6h. Sua internet pode ficar inst√°vel. Obrigado pela compreens√£o!",
        upgrade_plano:
          "üöÄ {{nome}}, que tal turbinar sua internet? Upgrade do seu {{plano}} para Fibra 200MB por apenas +R$ 30,00. Responda SIM!",
        boas_vindas:
          "üéâ Bem-vindo {{nome}}! Seu plano {{plano}} j√° est√° ativo. Suporte 24h: (11) 9999-9999. Obrigado por escolher nossa internet!",
      };

      async function getClientesERP(query) {
        try {
          const response = await fetch(
            "https://webhooks.coraxy.com.br/webhook/buscar_pelonome_erp",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                nome: query,
                account: "3",
                pagCampanhas: true,
              }),
            }
          );

          const data = await response.json();
          console.log("retorno api erp", data);
          return data; // devolve os clientes
        } catch (error) {
          console.error("Erro ao buscar clientes:", error);
          return [];
        }
      }

      async function getClientesMaestroCoraxy(query) {
        try {
          const response = await fetch(
            "https://webhooks.coraxy.com.br/webhook/buscar_pelonome_maestro",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                nome: query,
                account: "3",
                pagCampanhas: true,
              }),
            }
          );

          const data = await response.json();
          console.log("retorno api maestro", data);
          return data; // devolve os clientes
        } catch (error) {
          console.error("Erro ao buscar clientes:", error);
          return [];
        }
      }
      function showTab(tabName) {
  document.querySelectorAll(".tab-content").forEach((tab) => {
    tab.classList.remove("active");
  });

  document.querySelectorAll(".tab-button").forEach((btn) => {
    btn.classList.remove("active");
  });

  document.getElementById(tabName).classList.add("active");
  event.target.classList.add("active");

  // üî• Carregar os templates quando abrir a aba
  if (tabName === "templates") {
    carregarTemplates();
  }
}


      function showNovaCampanha() {
        showTab("contatos");
        document
          .querySelector(".nova-campanha")
          .scrollIntoView({ behavior: "smooth" });
      }

      // Fun√ß√£o de busca de clientes
      async function buscarContato(query) {
        if (query.length < 2) return;
        console.log("usarMaestroParaBusca", usarMaestroParaBusca);

        if (usarMaestroParaBusca) {
          clientes = await getClientesMaestroCoraxy(query);
        } else {
          clientes = await getClientesERP(query); // espera o fetch terminar
        }
        console.log("clientes recebidos:", clientes);

        const resultados = clientes.filter(
          (cliente) =>
            cliente.nome.toLowerCase().includes(query.toLowerCase()) ||
            cliente.numero.includes(query) ||
            (cliente.doc && cliente.doc.includes(query))
        );

        if (resultados.length > 0) {
          const cliente = resultados[0];
          console.log("Cliente encontrado:", cliente);

          // ‚úÖ agora funciona
          document.getElementById("numero").value = cliente.numero;
          updateDropdownPreview();
          showNotification(
            `Cliente encontrado: ${cliente.nome} - ${cliente.doc}`,
            "success"
          );
        }
      }

      // Buscar clientes vencidos
      function buscarClientesVencidos() {
        const dias = parseInt(document.getElementById("diasVencidos").value);
        const valorMinimo =
          parseFloat(document.getElementById("valorMinimo").value) || 0;
        const plano = document.getElementById("planoCliente").value;

        if (!dias) return;

        let clientesVencidos = clientes.filter((cliente) => {
          let atendeCriterios =
            cliente.diasVencido >= dias && cliente.valor >= valorMinimo;

          if (plano) {
            atendeCriterios =
              atendeCriterios && cliente.plano.toLowerCase().includes(plano);
          }

          return atendeCriterios;
        });

        exibirClientesVencidos(clientesVencidos);
      }

      function exibirClientesVencidos(clientesVencidos) {
        const grid = document.getElementById("clientesVencidosGrid");
        grid.innerHTML = "";

        if (clientesVencidos.length === 0) {
          grid.innerHTML =
            '<p style="text-align: center; color: #64748b; grid-column: 1/-1;">Nenhum cliente encontrado com os crit√©rios selecionados.</p>';
          return;
        }

        clientesVencidos.forEach((cliente) => {
          const card = document.createElement("div");
          card.className = "cliente-card";
          card.innerHTML = `
                    <h4>${cliente.nome}</h4>
                    <div class="cliente-info">üìû ${cliente.numero}</div>
                    <div class="cliente-info">üìã ${cliente.plano}</div>
                    <div class="cliente-info">üí∞ R$ ${(
                      Number(cliente.valor) || 0
                    ).toFixed(2)}</div>
                    <div class="dias-vencido">${
                      cliente.diasVencido
                    } dias vencido</div>
                    <button class="btn-small btn-report" style="margin-top: 8px;" onclick="selecionarClienteVencido('${
                      cliente.nome
                    }', '${cliente.numero}')">
                        Selecionar para Campanha
                    </button>
                `;
          grid.appendChild(card);
        });

        showNotification(
          `${clientesVencidos.length} clientes vencidos encontrados`,
          "success"
        );
      }

      function selecionarClienteVencido(nome, numero) {
  showTab("contatos");
  document.getElementById("buscarContato").value = nome;
  document.getElementById("numero").value = numero;
  document.getElementById("templateDropdown").value = ""; // usu√°rio escolhe
  updateDropdownPreview();
  showNotification(
    `Cliente ${nome} selecionado para campanha`,
    "success"
  );
}


      // Atualizar preview da mensagem
      function updateMessagePreview() {
        const template = document.getElementById("templateMeta").value;
        const numero = document.getElementById("numero").value;
        const preview = document.getElementById("messagePreview");

        if (template && templates[template]) {
          let mensagem = templates[template];

          // Encontrar cliente pelo n√∫mero
          const cliente = clientes.find((c) => c.numero === numero);
          const nome = cliente ? cliente.nome : "Cliente";
          const plano = cliente ? cliente.plano : "Seu Plano";
          const valor = cliente
            ? (Number(cliente.valor) || 0).toFixed(2)
            : "0,00";

          mensagem = mensagem.replace(/{{nome}}/g, nome);
          mensagem = mensagem.replace(/{{plano}}/g, plano);
          mensagem = mensagem.replace(/{{valor}}/g, valor);

          preview.textContent = mensagem;
        } else {
          preview.textContent =
            "Selecione um template para visualizar a mensagem";
        }
      }

      // Processar arquivo
      function processFile(input) {
        const file = input.files[0];
        if (
          file &&
          (file.type === "text/plain" || file.name.endsWith(".csv"))
        ) {
          const reader = new FileReader();
          const tabela = document.getElementById("tabelaNumeros");
          const tbody = tabela.querySelector("tbody");
          tbody.innerHTML = ""; // limpa antes de preencher

          reader.onload = function (e) {
            const content = e.target.result;
            const numeros = content
              .split(/\r?\n/)
              .filter((linha) => linha.trim());

            if (numeros.length > 0) {
              tabela.style.display = "table"; // s√≥ mostra se tiver n√∫mero
              showNotification(
                `Arquivo processado: ${numeros.length} n√∫meros encontrados`,
                "success"
              );

              let row;
              numeros.forEach((numero, index) => {
                if (index % 5 === 0) {
                  // quebra a cada 5 n√∫meros
                  row = document.createElement("tr");
                  tbody.appendChild(row);
                }
                const cell = document.createElement("td");
                cell.textContent = numero;
                cell.style.cssText = `
                        padding:2px 4px;
                        border:1px solid #444;
                        color:#fff;
                        text-align:center;
                        border-radius:4px;
                    `;
                row.appendChild(cell);
              });
            } else {
              tabela.style.display = "none"; // esconde se n√£o houver n√∫meros
              showNotification(
                "Nenhum n√∫mero v√°lido encontrado no arquivo",
                "warning"
              );
            }
          };
          reader.readAsText(file);
        } else {
          showNotification(
            "Por favor, selecione um arquivo TXT ou CSV v√°lido",
            "error"
          );
        }
      }

      // Enviar campanha
      function enviarCampanha() {
  const template = document.getElementById("templateDropdown").value;
  const numero = document.getElementById("numero").value;
  const nome = document.getElementById("buscarContato").value;

  if (!template || !numero) {
    showNotification(
      "Por favor, preencha todos os campos obrigat√≥rios",
      "error"
    );
    return;
  }

  const dadosCampanha = {
    tipo: "envio_imediato",
    template: template,
    numero: numero,
    timestamp: new Date().toISOString(),
    provedor: true,
  };

  console.log("Dados enviados para n8n/Chatwoot:", dadosCampanha);
  showNotification("Campanha enviada com sucesso!", "success");
  limparFormulario();
}


      // Agendar campanha
      function agendarCampanha() {
  const template = document.getElementById("templateDropdown").value;
  const numero = document.getElementById("numero").value;

  if (!template || !numero) {
    showNotification(
      "Por favor, preencha todos os campos obrigat√≥rios",
      "error"
    );
    return;
  }

  const dadosCampanha = {
    tipo: "agendamento",
    template: template,
    numero: numero,
    timestamp: new Date().toISOString(),
    provedor: true,
  };

  console.log("Campanha agendada:", dadosCampanha);
  showNotification("Campanha agendada com sucesso!", "success");
  limparFormulario();
}


      // Salvar rascunho
      function salvarRascunho() {
  const dadosRascunho = {
    template: document.getElementById("templateDropdown").value,
    numero: document.getElementById("numero").value,
    busca: document.getElementById("buscarContato").value,
    timestamp: new Date().toISOString(),
  };

  sessionStorage.setItem("rascunho_campanha", JSON.stringify(dadosRascunho));
  showNotification("Rascunho salvo com sucesso!", "success");
}


      function limparFormulario() {
  document.getElementById("templateDropdown").value = "";
  document.getElementById("numero").value = "";
  document.getElementById("buscarContato").value = "";
  updateDropdownPreview();
}




      // Ver relat√≥rio
      function verRelatorio(nomeCampanha) {
        const campanha = campanhas.find((c) => c.nome === nomeCampanha);
        if (campanha) {
          document.getElementById(
            "relatorioTitle"
          ).textContent = `Relat√≥rio - ${nomeCampanha}`;
          document.getElementById("totalContatos").textContent =
            campanha.contatos.toLocaleString();
          document.getElementById("mensagensEnviadas").textContent =
            campanha.enviados.toLocaleString();
          document.getElementById("mensagensEntregues").textContent =
            campanha.entregues.toLocaleString();
          document.getElementById("respostasRecebidas").textContent =
            campanha.respostas.toLocaleString();
          document.getElementById("taxaEntrega").textContent =
            campanha.enviados > 0
              ? ((campanha.entregues / campanha.enviados) * 100).toFixed(1) +
                "%"
              : "0%";
          document.getElementById("taxaResposta").textContent =
            campanha.entregues > 0
              ? ((campanha.respostas / campanha.entregues) * 100).toFixed(1) +
                "%"
              : "0%";
          document.getElementById("valorTotalCobrado").textContent =
            "R$ " +
            campanha.valorTotal.toLocaleString("pt-BR", {
              minimumFractionDigits: 2,
            });

          document.getElementById("relatorioModal").style.display = "block";
        }
      }

      // Fechar modal
      function closeModal() {
        document.getElementById("relatorioModal").style.display = "none";
      }

      // Atualizar tabela de campanhas
      function atualizarTabelaCampanhas() {
        const tbody = document.getElementById("campanhasTable");
        tbody.innerHTML = "";

        campanhas.forEach((campanha) => {
          const row = tbody.insertRow();
          const taxaEntrega =
            campanha.enviados > 0
              ? ((campanha.entregues / campanha.enviados) * 100).toFixed(1) +
                "%"
              : "-";

          row.innerHTML = `
                    <td>${campanha.nome}</td>
                    <td>${campanha.tipo}</td>
                    <td>${campanha.contatos.toLocaleString()}</td>
                    <td><span class="status ${campanha.status}">${
            campanha.status.charAt(0).toUpperCase() + campanha.status.slice(1)
          }</span></td>
                    <td>${
                      campanha.enviados > 0
                        ? campanha.enviados.toLocaleString()
                        : "-"
                    }</td>
                    <td>${taxaEntrega}</td>
                    <td>
                        <button class="btn-small btn-pause" onclick="pausarCampanha('${
                          campanha.nome
                        }')">
                            ${
                              campanha.status === "ativa"
                                ? "Pausar"
                                : "Reativar"
                            }
                        </button>
                        <button class="btn-small btn-report" onclick="verRelatorio('${
                          campanha.nome
                        }')">Relat√≥rio</button>

                        <button class="btn-small btn-report" onclick="verRelatorio('${
                          campanha.nome
                        }')">teste</button>
                    </td>
                `;
        });
      }

      // Mostrar notifica√ß√£o
     function showNotification(message, type) {
  const notification = document.getElementById("notification");
  notification.textContent = message;
  notification.className = `notification ${type} show`;

  setTimeout(() => {
    notification.classList.remove("show"); // aplica o fade out
    setTimeout(() => {
      notification.textContent = ""; // limpa o conte√∫do
    }, 600); // tempo do fade
  }, 10000); // fica 10s vis√≠vel
}

async function carregarTotalClientes() {
  try {
    const response = await fetch("https://webhooks.coraxy.com.br/webhook/total_clientes");
    const data = await response.json();

    // document.getElementById("totalClientes").textContent = 
    //   (data.total_clientes || 0).toLocaleString("pt-BR");

    total_clientes = data[0].total_clientes; // atualiza vari√°vel global
    // console.log("TESTEEEEEEEEE", data.)
    document.getElementById("totalClientes").textContent = total_clientes; // Exibe o total de clientes 
    console.log("Total de clientes carregado:", total_clientes);
    return data.total_clientes || 0;
  } catch (error) {
    console.error("Erro ao carregar total de clientes:", error);
  }
}


async function pausarOuReativarCampanha(id, concluida) {
  try {
    const concluidaBool = Boolean(concluida);

    const res = await fetch("https://webhooks.coraxy.com.br/webhook/atualizar_campanha", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: Number(id),
        concluida: concluidaBool
      })
    });

    const result = await res.json();
    console.log("Resposta do update:", result);

    showNotification(
      `Campanha ${concluidaBool ? "finalizada" : "reativada"} com sucesso!`,
      "success"
    );

    await carregarCampanhas(); // recarrega tabela

  } catch (err) {
    console.error("Erro ao atualizar campanha:", err);
    showNotification("Erro ao atualizar campanha", "error");
  }
}









async function carregarTotalVencidos() {
  try {
    const response = await fetch("https://webhooks.coraxy.com.br/webhook/clientes_vencidos"); 
    const data = await response.json();
    const total_vencidos = data[0].total_inadimplentes || 0;  

    document.getElementById("clientesVencidos").textContent = total_vencidos.toLocaleString("pt-BR");

    console.log("Total de clientes inadimplentes carregado:", total_vencidos);

    return total_vencidos;
  } catch (error) {
    console.error("Erro ao carregar total de clientes inadimplentes:", error);
  }
}

async function campanhas_ativas() {
  try {
    const response = await fetch("https://webhooks.coraxy.com.br/webhook/campanhas1"); 
    const data = await response.json();

    const totalCampanhas = parseInt(data[0].campanhas) || 0;

    document.getElementById("campanhasAtivas").textContent = totalCampanhas.toLocaleString("pt-BR");

    console.log("Total de campanhas ativas:", totalCampanhas);

    return totalCampanhas;
  } catch (error) {
    console.error("Erro ao carregar campanhas ativas:", error);
  }
}


async function cobrancas_feitas() {
  try {
    const response = await fetch("https://webhooks.coraxy.com.br/webhook/cobrancas_enviadas"); 
    const data = await response.json();
    const total_cobrancas = data[0].total_cobrancas || 0;

    document.getElementById("mensagensEnviadas").textContent = total_cobrancas.toLocaleString("pt-BR");

    console.log("Total de cobran√ßas enviadas (soma):", total_cobrancas);

    return total_cobrancas;
  } catch (error) {
    console.error("Erro ao carregar total de cobran√ßas:", error);
  }
}

async function carregarCampanhas() {
  const tbody = document.getElementById("campanhasTable");
  tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#aaa;">Carregando‚Ä¶</td></tr>`;

  try {
    const res = await fetch("https://webhooks.coraxy.com.br/webhook/campanhas", {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });
    const data = await res.json();
    console.log("Resposta do endpoint /campanhas:", data);

    let campanhas = Array.isArray(data) ? data : [];

    // üî• Ordena: ativas primeiro, finalizadas depois
    campanhas.sort((a, b) => {
      if (a.concluida !== b.concluida) {
        return a.concluida ? 1 : -1;
      }
      return new Date(b.date_disparo_inicio) - new Date(a.date_disparo_inicio);
    });

    tbody.innerHTML = "";

    if (campanhas.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#aaa;">Nenhuma campanha encontrada.</td></tr>`;
      return;
    }

    campanhas.forEach(camp => {
      const tr = document.createElement("tr");

      const status = camp.concluida ? "FINALIZADA" : "ATIVA";
      const statusClass = camp.concluida ? "pausada" : "ativa";

      const taxaEntrega =
        camp.enviados > 0
          ? ((camp.entregues / camp.enviados) * 100).toFixed(1) + "%"
          : "-";

      tr.innerHTML = `
        <td>${camp.nome || "-"}</td>
        <td>${camp.template || "-"}</td>
        <td>${camp.empresa || "-"}</td>
        <td><span class="status ${statusClass}">${status}</span></td>
        <td>${camp.enviados ?? "-"}</td>
        <td>${taxaEntrega}</td>
        <td>
          <button class="btn-small btn-pause"onclick="pausarOuReativarCampanha(${camp.id}, ${!camp.concluida})"
 "false" : "true"})"> ${camp.concluida ? "Reativar" : "Pausar"}</button>



          <button class="btn-small btn-report" onclick="verRelatorio('${camp.id}')">
            Relat√≥rio
          </button>
          <button class="btn-small btn-edit" onclick="verRelatorio('${camp.id}')">
            Editar
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("Erro ao carregar campanhas:", err);
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#f87171;">Erro ao carregar campanhas</td></tr>`;
  }
}




async function carregarTemplates() {
  const tbody = document.getElementById("templatesTable");
  tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#aaa;">Carregando‚Ä¶</td></tr>`;

  try {
    const res = await fetch("https://webhooks.coraxy.com.br/webhook/templates1");
    const data = await res.json();

    tbody.innerHTML = "";
    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#aaa;">Nenhum template encontrado.</td></tr>`;
      return;
    }

    data.forEach((t) => {
      const nome = t.nome_template || "-";
      const categoria = t.categoria || "-";
      const uso = t.uso ?? 0;
      const taxa = t.taxa_resposta != null ? `${Number(t.taxa_resposta).toFixed(1)}%` : "-";
      const status = t.status || "‚Äî";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${nome}</td>
        <td>${categoria}</td>
        <td>${Number(uso).toLocaleString("pt-BR")}</td>
        <td>${taxa}</td>
        <td><span class="status ${status === "Aprovado" ? "ativa" : "pausada"}">${status}</span></td>
        <td>
          <button class="btn-small btn-report" onclick="editarTemplate('${t.id}', '${nome}', '${categoria}', \`${t.conteudo || ""}\`)">Editar</button>
          
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Erro ao carregar templates:", err);
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#f87171;">Erro ao carregar templates</td></tr>`;
  }
}



function editarTemplate(id, nome, categoria, conteudo) {
  document.getElementById("editTemplateId").value = id;
  document.getElementById("editTemplateNome").value = nome;
  document.getElementById("editTemplateCategoria").value = categoria;
  document.getElementById("editTemplateConteudo").value = conteudo;
  document.getElementById("editarTemplateModal").style.display = "block";
}

function closeEditModal() {
  document.getElementById("editarTemplateModal").style.display = "none";
}

async function salvarTemplate() {
  const id = document.getElementById("editTemplateId").value;
  const nome = document.getElementById("editTemplateNome").value;
  const categoria = document.getElementById("editTemplateCategoria").value;
  const conteudo = document.getElementById("editTemplateConteudo").value;

  try {
    const res = await fetch("https://webhooks.coraxy.com.br/webhook/atualizar_template", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, nome_template: nome, categoria, conteudo })
    });
    await res.json();

    showNotification("Template atualizado com sucesso!", "success");
    closeEditModal();
    carregarTemplates();
  } catch (err) {
    console.error("Erro ao atualizar template:", err);
    showNotification("Erro ao atualizar template", "error");
  }
}


function editarTemplate(id, nome, categoria, conteudo) {
  document.getElementById("editTemplateId").value = id;
  document.getElementById("editTemplateNome").value = nome;
  document.getElementById("editTemplateCategoria").value = categoria;
  document.getElementById("editTemplateConteudo").value = conteudo;
  document.getElementById("editarTemplateModal").style.display = "block";
}

function closeEditModal() {
  document.getElementById("editarTemplateModal").style.display = "none";
}

async function salvarTemplate() {
  const id = document.getElementById("editTemplateId").value;
  const nome = document.getElementById("editTemplateNome").value;
  const categoria = document.getElementById("editTemplateCategoria").value;
  const conteudo = document.getElementById("editTemplateConteudo").value;

  try {
    const res = await fetch("https://webhooks.coraxy.com.br/webhook/atualizar_template", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, nome_template: nome, categoria, conteudo })
    });
    await res.json();

    showNotification("Template atualizado com sucesso!", "success");
    closeEditModal();
    carregarTemplates();
  } catch (err) {
    console.error("Erro ao atualizar template:", err);
    showNotification("Erro ao atualizar template", "error");
  }
}




let dropdownTemplatesCache = []; // cache exclusivo do dropdown

async function carregarTemplatesDropdown() {
  try {
    // Endpoint espec√≠fico para trazer templates
    const res = await fetch("https://webhooks.coraxy.com.br/webhook/templates1");
    const templates = await res.json();

    dropdownTemplatesCache = templates; // guarda s√≥ para o dropdown

    const select = document.getElementById("templateDropdown");
    select.innerHTML = '<option value="">Selecionar template</option>';

    templates.forEach(tpl => {
      const option = document.createElement("option");
      option.value = tpl.id; 
      option.textContent = tpl.nome_template;
      select.appendChild(option);
    });

  } catch (err) {
    console.error("Erro ao carregar templates no dropdown:", err);
  }
}

function updateDropdownPreview() {
  const select = document.getElementById("templateDropdown");
  const preview = document.getElementById("messagePreview"); // üëà agora s√≥ esse

  const selectedId = select.value;
  if (!selectedId) {
    preview.textContent = "Selecione um template para visualizar a mensagem";
    return;
  }

  const tpl = dropdownTemplatesCache.find(t => String(t.id) === selectedId);
  if (tpl) {
    preview.textContent = tpl.conteudo || "Este template n√£o possui conte√∫do.";
  } else {
    preview.textContent = "Erro: template n√£o encontrado.";
  }
}




// Chame quando abrir a aba ‚ÄúTemplates‚Äù
function showTab(tabName) {
  document.querySelectorAll(".tab-content").forEach((tab) => tab.classList.remove("active"));
  document.querySelectorAll(".tab-button").forEach((btn) => btn.classList.remove("active"));

  document.getElementById(tabName).classList.add("active");
  event.target.classList.add("active");

  if (tabName === "templates") {
    carregarTemplates();
  }
}





      // Fechar modal ao clicar fora
      window.onclick = function (event) {
        const modal = document.getElementById("relatorioModal");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };

      // Carregar rascunho salvo
      function carregarRascunho() {
  const rascunho = sessionStorage.getItem("rascunho_campanha");
  if (rascunho) {
    const dados = JSON.parse(rascunho);
    document.getElementById("templateDropdown").value = dados.template || "";
    document.getElementById("numero").value = dados.numero || "";
    document.getElementById("buscarContato").value = dados.busca || "";
    updateDropdownPreview();
  }
}

function criarCampanha() {
  showNotification("Campanha criada com sucesso!", "success");
  // aqui voc√™ pode integrar com o fluxo do n8n depois
}

    </script>
  </body>
</html>